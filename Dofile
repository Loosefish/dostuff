#!/bin/sh

target="./dostuff"

do_valgrind() {
	valgrind --error-exitcode=10 ./dostuff -f 2>/dev/null >/dev/null || echo "errors"
	valgrind --error-exitcode=10 ./dostuff -p 2>/dev/null >/dev/null || echo "errors"

	valgrind --error-exitcode=10 ./dostuff 2>/dev/null >/dev/null || echo "errors"
	valgrind --error-exitcode=10 ./dostuff normal 2>/dev/null >/dev/null || echo "errors"
	valgrind --error-exitcode=10 ./dostuff args 100 200 300 ABC 2>/dev/null >/dev/null || echo "errors"

	cp Dofile ../Dorec

	DOFILE="Dorec" valgrind --error-exitcode=10 ./dostuff 2>/dev/null >/dev/null || echo "errors"
	DOFILE="Dorec" valgrind --error-exitcode=10 ./dostuff normal 2>/dev/null >/dev/null || echo "errors"
	DOFILE="Dorec" valgrind --error-exitcode=10 ./dostuff args 100 200 300 ABC 2>/dev/null >/dev/null || echo "errors"

	rm ../Dorec
}


do_test () {
    for t in tests/*.sh; do
        echo -n "${t}: "
        if ${t} ${target} 2>/dev/null; then
            echo -e "\e[32msuccess\e[0m"
        else
            echo -e "\e[31mfailure\e[0m"
        fi
    done
}
